package com.facol.projeto.service.implementacao;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;

import com.facol.projeto.dto.PautaRequestDTO;
import com.facol.projeto.dto.PautaResponseDTO;
import com.facol.projeto.enums.StatusPauta;
import com.facol.projeto.exceptions.PautaNaoEncontrada;
import com.facol.projeto.model.Associado;
import com.facol.projeto.model.Pauta;
import com.facol.projeto.repositories.PautaRepositorio;
import com.facol.projeto.repositories.VotacaoRepositorio;
import com.facol.projeto.service.PautaCadastrarAlterarService;
import com.facol.projeto.service.PautaConsultarService;
import com.facol.projeto.service.VotacaoConsultaService;
import com.facol.projeto.service.factory.PautaFactory;
import com.facol.projeto.service.validacao.ValidacaoStrategy;

@Service
public class PautaServiceImplementacao implements PautaCadastrarAlterarService, PautaConsultarService {
	@Autowired
	private PautaRepositorio pautaRepositorio;
	@Autowired
	private VotacaoRepositorio votacaoRepositorio;
	@Autowired
	private PautaFactory pautaFactory;

	@Autowired
	private VotacaoConsultaService votacaoService;
	@Autowired
	@Qualifier("TituloDescricaoValidacao")
	private ValidacaoStrategy<PautaRequestDTO> validacaoStrategyTituloDescricao;
	@Autowired
	@Qualifier("TempoVotacaoValidacao")
	private ValidacaoStrategy<Pauta> validacaoStrategyTempo;

	@Override
	public void cadastrarPauta(Associado associado, PautaRequestDTO pautaRequestDTO) {
		this.validacaoStrategyTituloDescricao.validacao(pautaRequestDTO);
		Pauta pauta = this.pautaFactory.criarPauta(pautaRequestDTO, associado);
		pautaRepositorio.save(pauta);
		abrirVotacao(pauta);
	}

	private void abrirVotacao(Pauta pauta) {
		validacaoStrategyTempo.validacao(pauta);
		if (pauta.getEstadoPauta() == StatusPauta.EM_VOTOCAO) {

			votacaoRepositorio.save(pautaFactory.criarVotacao(pauta));
		}

	}

	@Override
	public void alterarPauta(Long id, PautaRequestDTO requestDTO) {
		Pauta pauta = this.pegarPautaDB(id);
		pauta.setDescricao(requestDTO.getDescricao());
		pauta.setTitulo(requestDTO.getTitulo());
		this.pautaRepositorio.save(pauta);
	}

	@Override
	public Page<Pauta> buscarPautas(Pageable pageAble) {
		this.pegarPautaParaAtualizar(this.pautaRepositorio.findAll());
		return this.pautaRepositorio.findAll(pageAble);

	}
	@Override
	public Page<PautaResponseDTO> pegarEmAberto(Pageable pageAble) {
		Page<PautaResponseDTO> pautas = this.buscarPautas(pageAble);
		List<PautaResponseDTO> filtradas = pautas.stream().filter(pauta -> pauta.status_Pauta() == StatusPauta.EM_VOTOCAO).toList();
		return new PageImpl<>(filtradas, pageAble, filtradas.size());
	}


	@Override
	public PautaResponseDTO pegarPauta(Long id) {

		return pautaFactory.criarPautaResponseDTO(this.pegarPautaDB(id));

	}

	private Pauta pegarPautaDB(Long id) {
		Pauta pauta = this.pautaRepositorio.findById(id).orElseThrow(() -> new PautaNaoEncontrada());
		this.votacaoService.buscarVotacaoPorPauta(id);
		;
		return pauta;
	}

	@Override
	public void deletarPauta(Long id) {
		this.pautaRepositorio.deleteById(id);

	}

	@Override
	public void pegarPautaParaAtualizar(List<Pauta> pautas) {
		pautas.forEach(pauta -> this.votacaoService.buscarVotacaoPorPauta(pauta.getId_pauta()));
	}

	
}
